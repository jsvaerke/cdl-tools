From 21b440c1f0ff3d3c19bb143345b61057af49fea5 Mon Sep 17 00:00:00 2001
From: Damien Le Moal <damien.lemoal@opensource.wdc.com>
Date: Mon, 11 Apr 2022 14:01:34 +0900
Subject: [PATCH 22/34] block: Introduce BLK_STS_DURATION_LIMIT

Introduce the new block IO status BLK_STS_DURATION_LIMIT for LLDDs to
report command that failed due to a command duration limit being
exceeded. This new status is mapped to the ETIME error code to allow
users to differenciate "soft" duration limit failures from other more
serious hardware related errors.

Signed-off-by: Damien Le Moal <damien.lemoal@opensource.wdc.com>
---
 block/blk-core.c          | 3 +++
 include/linux/blk_types.h | 3 ++-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/block/blk-core.c b/block/blk-core.c
index 26664f2a139e..56da6ebdddc8 100644
--- a/block/blk-core.c
+++ b/block/blk-core.c
@@ -190,6 +190,9 @@ static const struct {
 	[BLK_STS_ZONE_OPEN_RESOURCE]	= { -ETOOMANYREFS, "open zones exceeded" },
 	[BLK_STS_ZONE_ACTIVE_RESOURCE]	= { -EOVERFLOW, "active zones exceeded" },
 
+	/* Command duration limit device-side timeout */
+	[BLK_STS_DURATION_LIMIT]	= { -ETIME, "duration limit exceeded" },
+
 	/* everything else not covered above: */
 	[BLK_STS_IOERR]		= { -EIO,	"I/O" },
 };
diff --git a/include/linux/blk_types.h b/include/linux/blk_types.h
index d9b69bbde5cc..18ce3f51fa3e 100644
--- a/include/linux/blk_types.h
+++ b/include/linux/blk_types.h
@@ -67,7 +67,8 @@ typedef u8 __bitwise blk_status_t;
 #define BLK_STS_MEDIUM		((__force blk_status_t)7)
 #define BLK_STS_PROTECTION	((__force blk_status_t)8)
 #define BLK_STS_RESOURCE	((__force blk_status_t)9)
-#define BLK_STS_IOERR		((__force blk_status_t)10)
+#define BLK_STS_DURATION_LIMIT	((__force blk_status_t)10)
+#define BLK_STS_IOERR		((__force blk_status_t)11)
 
 /* hack for device mapper, don't use elsewhere: */
 #define BLK_STS_DM_REQUEUE    ((__force blk_status_t)11)
-- 
2.35.1

